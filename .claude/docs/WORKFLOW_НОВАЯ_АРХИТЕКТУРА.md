# WORKFLOW: Как работает новая архитектура агентов

## 🎯 СЦЕНАРИЙ 1: Пользователь дал задачу Claude Code

```
┌─────────────────────────────────────────────────────────────┐
│ USER: "Создай payment integration для проекта"              │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ CLAUDE CODE: Читаю корневой CLAUDE.md (100 строк)          │
│                                                             │
│ Вижу правило:                                               │
│ ✅ ВСЕГДА принимать роль Project Manager                    │
│ ❌ НИКОГДА не работать как Claude Code                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ CLAUDE CODE: Ищу промпт Project Manager                    │
│                                                             │
│ Glob(pattern="**/project-manager*.md")                      │
│ → Найден: .claude/agents/project-manager.md                │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ CLAUDE CODE: Читаю системный промпт PM (400 строк)         │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 🎭 ПЕРЕКЛЮЧАЮСЬ В РОЛЬ PROJECT MANAGER                      │
│                                                             │
│ Моя экспертиза:                                             │
│ • Декомпозиция задач                                        │
│ • Делегирование правильным агентам                          │
│ • Приоритизация                                             │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ PROJECT MANAGER: Читаю свои правила                         │
│                                                             │
│ 1. ai-agents/CLAUDE.md (300 строк)                         │
│ 2. .claude/knowledge/common_agent_rules.md (500 строк)     │
│ 3. WORKFLOW_PM_AGENT_LIBRARY_MANAGEMENT.md (200 строк)     │
│                                                             │
│ PM читает ТОЛЬКО эти файлы (Context7 НЕ упомянут)          │
│                                                             │
│ ИТОГО: 100 + 400 + 300 + 500 + 200 = 1,500 токенов         │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ PROJECT MANAGER: TodoWrite с микрозадачами                  │
│                                                             │
│ 1. Проанализировать задачу "payment integration"           │
│ 2. Проверить библиотеку агентов: Glob(.claude/agents/)     │
│ 3. Создать задачу в Archon для Payment Integration Agent   │
│ 4. Обновить статус в Archon                                │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ PROJECT MANAGER: Выполняю микрозадачи                       │
│                                                             │
│ [1/4] Анализ: payment integration требует специалиста      │
│ [2/4] Библиотека: Glob(.claude/agents/*.md)                │
│       → payment-integration-agent.md НАЙДЕН                 │
│ [3/4] Создаю задачу в Archon:                              │
│       mcp__archon__manage_task(                             │
│         "create",                                           │
│         assignee="Payment Integration Agent",               │
│         title="Интегрировать Stripe payment",               │
│         status="todo"                                       │
│       )                                                     │
│ [4/4] Статус: done                                          │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ PROJECT MANAGER → USER:                                     │
│                                                             │
│ ✅ Задача завершена: Делегирование payment integration     │
│                                                             │
│ 🎯 Что выполнено:                                           │
│ - Проанализирована задача через Context7                   │
│ - Найден Payment Integration Agent в библиотеке            │
│ - Создана задача в Archon для агента                       │
│                                                             │
│ 📋 Следующая задача:                                        │
│ Payment Integration Agent получил задачу и начнет работу   │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 СЦЕНАРИЙ 2: Payment Integration Agent получил задачу из Archon

```
┌─────────────────────────────────────────────────────────────┐
│ ARCHON NOTIFICATION: Новая задача для Payment Integration  │
│ Agent                                                       │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ CLAUDE CODE: Читаю корневой CLAUDE.md (100 строк)          │
│                                                             │
│ Вижу: нужен Payment Integration Agent                      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ CLAUDE CODE: Ищу промпт агента                             │
│                                                             │
│ Glob(pattern="**/payment-integration*.md")                  │
│ → Найден: .claude/agents/payment-integration-agent.md      │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ CLAUDE CODE: Читаю системный промпт агента (600 строк)     │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 🎭 ПЕРЕКЛЮЧАЮСЬ В РОЛЬ PAYMENT INTEGRATION AGENT            │
│                                                             │
│ Моя экспертиза:                                             │
│ • Stripe/PayPal/Payment интеграции                          │
│ • Webhooks и обработка платежей                             │
│ • Безопасность платежных данных                             │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ PAYMENT AGENT: Выполняю workflow из промпта                 │
│                                                             │
│ Мой промпт payment-integration-agent.md содержит:           │
│ "ОБЯЗАТЕЛЬНО перед работой:"                                │
│                                                             │
│ 1. Анализ задачи: Прочитать детали из Archon task_id       │
│ 2. Context7 СРАЗУ: "Stripe integration examples"           │
│    → Нашел актуальные примеры checkout session             │
│ 3. Прочитать common_agent_rules.md (500 строк)             │
│ 4. Прочитать context7_integration.md (200 строк)           │
│                                                             │
│ ИТОГО: 100 + 600 + 500 + 200 = 1,400 токенов               │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ PAYMENT AGENT: TodoWrite с микрозадачами (Context7 готов!) │
│                                                             │
│ 1. Прочитать существующий код проекта (payment module)      │
│ 2. Создать Stripe checkout flow (по примерам из Context7)  │
│ 3. Настроить webhooks обработку                             │
│ 4. Добавить тесты payment flow                              │
│ 5. Рефлексия: проверить безопасность и соответствие PCI    │
│ 6. Спросить у пользователя о немедленных исправлениях       │
│ 7. Git commit + push + проверка логов деплоя                │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ PAYMENT AGENT: Выполняю микрозадачи                         │
│                                                             │
│ [1/7] Grep(pattern="payment", path="src/")                  │
│       → Нашел src/payment/base.py (существующая структура) │
│                                                             │
│ [2/7] Создаю src/payment/stripe_integration.py             │
│       (на основе примеров из Context7 полученных ранее)     │
│                                                             │
│ [3/7] Настраиваю webhooks endpoint /api/stripe/webhook     │
│       ...                                                   │
│                                                             │
│ [7/7] Git commit + push + railway logs --tail                │
│       ✅ Deployment successful                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 🎯 СЦЕНАРИЙ 3: Нужен новый агент (его нет в библиотеке)

```
┌─────────────────────────────────────────────────────────────┐
│ PROJECT MANAGER: Получил задачу "Setup Kubernetes deploy"  │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ PROJECT MANAGER: Проверяю библиотеку агентов                │
│                                                             │
│ Glob(pattern="**/*kubernetes*.md", path=".claude/agents/") │
│ → НЕ НАЙДЕН                                                 │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ PROJECT MANAGER: СТОП - нужен новый агент                   │
│                                                             │
│ 🚨 Переключаюсь в роль Blueprint Architect                 │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 🎭 ПЕРЕКЛЮЧАЮСЬ В РОЛЬ BLUEPRINT ARCHITECT                  │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ BLUEPRINT ARCHITECT: Создаю нового агента                   │
│                                                             │
│ 1. Context7 → "kubernetes deployment patterns"             │
│ 2. Создаю .claude/agents/kubernetes-deployment-agent.md    │
│ 3. Пишу системный промпт:                                   │
│    - Экспертиза в K8s                                       │
│    - Workflow: задача → Context7 СРАЗУ → файлы → TodoWrite │
│    - Context7 query для примеров (НЕ сами примеры!)        │
│ 4. Сохраняю в библиотеку                                    │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ BLUEPRINT ARCHITECT → PROJECT MANAGER:                      │
│                                                             │
│ ✅ Создан Kubernetes Deployment Agent                       │
│ 📁 Локация: .claude/agents/kubernetes-deployment-agent.md  │
│                                                             │
│ 🔄 Возвращаюсь в роль Project Manager                       │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ 🎭 ПЕРЕКЛЮЧАЮСЬ ОБРАТНО В РОЛЬ PROJECT MANAGER              │
└─────────────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────────────┐
│ PROJECT MANAGER: Делегирую задачу новому агенту             │
│                                                             │
│ mcp__archon__manage_task(                                   │
│   "create",                                                 │
│   assignee="Kubernetes Deployment Agent",                   │
│   title="Setup K8s deployment для проекта"                  │
│ )                                                           │
└─────────────────────────────────────────────────────────────┘
```

---

## 📊 СРАВНЕНИЕ: Старая vs Новая архитектура

### Старая архитектура (agent-factory)

```
USER задача
    ↓
CLAUDE CODE читает:
    - CLAUDE.md (4,200 строк) = 44,500 токенов
    - 01_role_switching.md (255 строк) = 2,800 токенов
    - module_selection.md (332 строки) = 3,600 токенов
    - 2 модуля CRITICAL (1,120 строк) = 12,000 токенов
    - common_agent_rules.md = 5,000 токенов
    - Существующий код проекта = 30,000 токенов
    ↓
TOTAL PREPARATION: 93,000 токенов (46.5% контекста!)
    ↓
Переключение в роль агента
    ↓
Работа
```

### Новая архитектура (ai-agents)

```
USER задача
    ↓
CLAUDE CODE читает:
    - Корневой CLAUDE.md (100 строк) = 100 токенов
    ↓
Переключение в роль Project Manager
    ↓
PM читает:
    - Корневой CLAUDE.md = 100 токенов
    - project-manager.md (400 строк) = 400 токенов
    - ai-agents/CLAUDE.md (300 строк) = 300 токенов
    - common_agent_rules.md (500 строк) = 500 токенов
    - WORKFLOW_PM_AGENT_LIBRARY_MANAGEMENT.md (200 строк) = 200 токенов
    ↓
TOTAL PM PREPARATION: 1,500 токенов (0.75% контекста)
    ↓
PM делегирует → code-writing агент читает по указанию из своего промпта:
    - Корневой CLAUDE.md = 100 токенов
    - agent-specific.md = 600 токенов
    - common_agent_rules.md = 500 токенов
    - context7_integration.md = 200 токенов
    ↓
TOTAL AGENT PREPARATION: 1,400 токенов (0.7% контекста)
    ↓
Работа с Context7 примерами (on-demand)
```

**ИТОГО ЭКОНОМИЯ:**
- Старая: 93,000 токенов preparation
- Новая (PM): 1,500 токенов preparation
- Новая (Code Agent): 1,400 токенов preparation
- **SAVINGS: 98.4% reduction!**

---

## ✅ КЛЮЧЕВЫЕ ПРЕИМУЩЕСТВА WORKFLOW

### 1. Минимальный старт
- Claude Code читает только 100 токенов
- Сразу понятно: нужен Project Manager

### 2. Just-in-time чтение
- PM читает только свои правила (1,500 токенов)
- Code-writing агент читает свои правила по указанию из промпта (1,400 токенов)
- Каждый агент читает только то что ему нужно

### 3. Context7 вместо хранения примеров
- Примеры не в промптах (экономия токенов)
- On-demand поиск актуальных примеров
- Всегда свежая документация

### 4. Библиотека агентов растет органически
- Создаем агента когда нужен
- Переиспользуем в других проектах
- Каждый агент содержит список что он должен читать

### 5. Четкая иерархия правил
- Корневой CLAUDE.md: критичное (Archon + роль PM)
- ai-agents/CLAUDE.md: правила PM
- common_agent_rules.md: общее для всех
- agent-specific.md: специфика + список файлов для чтения
- context7_integration.md: читается только code-writing агентами
